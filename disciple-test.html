<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 제자상 테스트 - 인공지능 관상 분석</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-models/speech-commands@latest/dist/speech-commands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-logo"><a href="index.html">Daily Bible</a></div>
            <ul class="nav-links">
                <li><a href="index.html">홈</a></li>
                <li><a href="faith-checkup.html">신앙 점검</a></li>
                <li><a href="disciple-test.html" class="active">제자상 테스트</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <div class="container">
            <section class="test-header card">
                <h1>AI 제자상 분석기</h1>
                <p>당신의 모습 속에 담긴 주님의 제자 모습을 인공지능이 분석합니다.</p>
                <div class="alert-info" style="font-size: 0.8rem; color: #666; margin-top: 10px;">
                    * 카메라 권한이 필요합니다. 분석된 이미지는 서버에 저장되지 않습니다.
                </div>
            </section>

            <div class="test-container card">
                <div id="webcam-container" style="margin-bottom: 20px; border-radius: 15px; overflow: hidden; background: #000; min-height: 200px; display: flex; align-items: center; justify-content: center;">
                    <button type="button" class="primary-btn" onclick="init()">카메라 시작하기 (Start AI)</button>
                </div>
                
                <div id="label-container" style="margin-top: 20px;"></div>
                
                <div id="ai-result" class="result-box" style="display: none; margin-top: 30px; padding: 20px; border: 2px solid #FFAB40; border-radius: 10px; background: #FFF8E1;">
                    <h2 id="disciple-name" style="color: #D84315;">분석 중...</h2>
                    <p id="disciple-desc" style="line-height: 1.6; margin-top: 10px;"></p>
                </div>
            </div>
        </div>
    </main>

    <script type="text/javascript">
        // 모델 URL (Teachable Machine에서 업로드 후 생성된 URL을 여기에 넣으세요)
        let URL = ""; // 예: "https://teachablemachine.withgoogle.com/models/xxxx/"

        let model, webcam, labelContainer, maxPredictions;

        async function init() {
            if (!URL) {
                alert("Teachable Machine 모델 URL을 설정해주세요! 현재는 데모 모드입니다.");
                return;
            }

            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            document.getElementById('webcam-container').innerHTML = "모델 로딩 중...";

            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            const flip = true;
            webcam = new tmImage.Webcam(300, 300, flip);
            await webcam.setup();
            await webcam.play();
            window.requestAnimationFrame(loop);

            document.getElementById("webcam-container").innerHTML = "";
            document.getElementById("webcam-container").appendChild(webcam.canvas);
            
            labelContainer = document.getElementById("label-container");
            for (let i = 0; i < maxPredictions; i++) {
                labelContainer.appendChild(document.createElement("div"));
            }
        }

        async function loop() {
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            let highestProb = 0;
            let bestMatch = "";

            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction = prediction[i].className + ": " + (prediction[i].probability * 100).toFixed(0) + "%";
                labelContainer.childNodes[i].innerHTML = `
                    <div style="margin-bottom: 5px;">
                        <span style="display:inline-block; width:100px;">${prediction[i].className}</span>
                        <div style="display:inline-block; width:200px; background:#eee; height:10px; border-radius:5px;">
                            <div style="width:${(prediction[i].probability * 100)}%; background:#FFAB40; height:100%; border-radius:5px;"></div>
                        </div>
                    </div>
                `;

                if (prediction[i].probability > highestProb) {
                    highestProb = prediction[i].probability;
                    bestMatch = prediction[i].className;
                }
            }

            if (highestProb > 0.8) {
                showResult(bestMatch);
            }
        }

        const discipleInfo = {
            "개척하는 바울": "당신은 복음의 불모지를 개척하는 용기를 가졌습니다. 새로운 도전을 두려워하지 마세요.",
            "지혜로운 솔로몬": "당신에게는 하나님의 지혜가 머물러 있습니다. 분별력 있게 세상을 이끌어갈 것입니다.",
            "위로하는 바나바": "당신은 사람을 세우는 은사가 있습니다. 당신의 격려가 한 영혼을 살릴 것입니다.",
            "충성된 다윗": "당신은 예배의 기쁨을 아는 사람입니다. 하나님을 향한 당신의 찬양을 기뻐하십니다.",
            "담대한 에스더": "당신은 위기의 시대에 부름받은 사람입니다. 당신의 결단이 공동체를 구할 것입니다.",
            "섬기는 마르다": "당신의 수고로운 손길을 주님께서 알고 계십니다. 봉사를 통해 하나님의 나라가 확장됩니다.",
            "기도의 다니엘": "당신은 기도로 승부하는 영적 용사입니다. 무릎으로 세상을 이기는 삶을 사세요.",
            "전하는 베드로": "당신은 사람을 낚는 어부입니다. 당신의 입술을 통해 복음의 능력이 나타날 것입니다."
        };

        function showResult(name) {
            const resBox = document.getElementById('ai-result');
            resBox.style.display = 'block';
            document.getElementById('disciple-name').innerText = "결과: " + name;
            document.getElementById('disciple-desc').innerText = discipleInfo[name] || "당신은 소중한 주님의 제자입니다.";
        }
    </script>
</body>
</html>
