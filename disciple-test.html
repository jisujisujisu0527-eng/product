<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="test_header">AI 제자상 테스트 - 인공지능 관상 분석</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="style.css">
    <!-- Teachable Machine Library -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"></script>
</head>
<body>
    <header>
        <div class="container">
            <nav class="navbar">
                <div class="nav-logo">
                    <a href="index.html" data-i18n="site_logo">British Daily Bible</a>
                </div>
                <ul class="nav-links">
                    <li><a href="index.html" data-i18n="nav_home">Home</a></li>
                    <li><a href="disciple-test.html" data-i18n="nav_test">AI Disciple</a></li>
                    <li><a href="faith-checkup.html" data-i18n="nav_checkup">Faith Check</a></li>
                    <li><a href="faith-dashboard.html" data-i18n="nav_dashboard">Dashboard</a></li>
                    <li><a href="community.html" data-i18n="nav_community">Community</a></li>
                    <li><a href="chat.html" data-i18n="nav_chat">Apostle Chat</a></li>
                </ul>
                <div class="lang-switcher">
                    <button onclick="changeLanguage('ko')" class="lang-btn">KO</button>
                    <button onclick="changeLanguage('en')" class="lang-btn">EN</button>
                    <button onclick="changeLanguage('es')" class="lang-btn">ES</button>
                    <button onclick="changeLanguage('fr')" class="lang-btn">FR</button>
                </div>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <section class="test-header card" style="text-align: center; padding: 40px;">
                <h1 data-i18n="test_header">AI 제자상 분석기</h1>
                <p data-i18n="test_desc">나의 얼굴상에 담긴 제자의 모습은 무엇일까요? 사진을 올려 확인해보세요.</p>
                <div class="alert-info" style="font-size: 0.8rem; color: #666; margin-top: 10px;" data-i18n="test_alert">
                    * 사진은 서버에 저장되지 않고 브라우저에서만 분석됩니다.
                </div>
            </section>

            <div class="test-container card" style="margin-top: 30px; text-align: center;">
                <!-- Image Upload Area -->
                <div class="upload-area" style="border: 2px dashed #ddd; padding: 40px; border-radius: 20px; margin-bottom: 20px;">
                    <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="readURL(this);">
                    
                    <div id="image-preview-container" style="display: none; margin-bottom: 20px;">
                        <img id="imagePreview" src="#" alt="your image" style="max-width: 100%; max-height: 300px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);" />
                    </div>

                    <div id="upload-label-container">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #B08968; margin-bottom: 15px;"></i>
                        <h3 style="margin-bottom: 20px;" data-i18n="upload_photo">사진을 업로드해주세요</h3>
                        <button type="button" class="primary-btn" onclick="document.getElementById('imageUpload').click();">
                            <i class="fas fa-image"></i> <span data-i18n="btn_select_photo">사진 선택하기</span>
                        </button>
                    </div>
                </div>

                <!-- Analysis Button -->
                <div id="loading-area" style="display: none;">
                    <p style="font-size: 1.2rem; font-weight: bold; color: #2C3E50;" data-i18n="analyzing">AI가 당신의 제자상을 분석 중입니다...</p>
                    <div style="margin-top: 10px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #B08968;"></i>
                    </div>
                </div>

                <!-- Result Area -->
                <div id="result-area" style="display: none; margin-top: 30px; padding: 30px; background: #F9F7F2; border-radius: 15px; border: 1px solid #B08968;">
                    <h2 id="result-title" style="color: #D84315; font-family: 'Lora', serif; margin-bottom: 15px;"></h2>
                    <p id="result-desc" style="line-height: 1.8; color: #333;"></p>
                    
                    <!-- Progress Bars -->
                    <div id="label-container" style="margin-top: 25px; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto;"></div>
                    
                    <button onclick="window.location.reload();" class="secondary-btn" style="margin-top: 30px;" data-i18n="btn_retry">다른 사진으로 다시하기</button>
                </div>
            </div>
        </div>
    </main>

    <script src="translations.js"></script>
    <script src="main.js"></script>
    <script type="text/javascript">
        // Teachable Machine URL
        const URL = "https://teachablemachine.withgoogle.com/models/YOUR_MODEL_URL/"; 

        let model, maxPredictions;

        async function init() {
            if (URL === "https://teachablemachine.withgoogle.com/models/YOUR_MODEL_URL/") {
                alert(translations[currentLang].model_error || "Model URL not set.");
                return false;
            }
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();
            return true;
        }

        async function predict() {
            const image = document.getElementById("imagePreview");
            const prediction = await model.predict(image, false);
            
            prediction.sort((a, b) => b.probability - a.probability);
            const bestMatch = prediction[0];

            const resultTitle = document.getElementById("result-title");
            const resultDesc = document.getElementById("result-desc");
            const labelContainer = document.getElementById("label-container");

            const archetypeKey = getArchetypeKey(bestMatch.className);
            resultTitle.innerText = translations[currentLang][archetypeKey] || bestMatch.className;
            resultDesc.innerText = translations[currentLang][archetypeKey + "_desc"] || "";

            labelContainer.innerHTML = "";
            for (let i = 0; i < 3; i++) {
                if (i >= prediction.length) break;
                const p = prediction[i];
                const width = (p.probability * 100).toFixed(1) + "%";
                const color = i === 0 ? "#D84315" : "#B08968";
                
                const archKey = getArchetypeKey(p.className);
                const displayName = translations[currentLang][archKey] || p.className;
                
                const barHtml = `
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 3px;">
                            <span>${displayName}</span>
                            <span>${width}</span>
                        </div>
                        <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${width}; background: ${color}; height: 100%;"></div>
                        </div>
                    </div>
                `;
                labelContainer.insertAdjacentHTML('beforeend', barHtml);
            }

            document.getElementById("loading-area").style.display = "none";
            document.getElementById("result-area").style.display = "block";
        }

        function getArchetypeKey(className) {
            const map = {
                "열정의 베드로": "arch_peter",
                "묵묵한 안드레": "arch_andrew",
                "우레의 아들 야고보": "arch_james_thunder",
                "사랑의 요한": "arch_john",
                "빌립": "arch_philip",
                "진실한 바돌로매": "arch_bartholomew",
                "확신의 도마": "arch_thomas",
                "변화된 마태": "arch_matthew",
                "작은 야고보": "arch_james_less",
                "용기 있는 다대오": "arch_thaddaeus",
                "열혈당원 시몬": "arch_simon",
                "선택받은 맛디아": "arch_matthias",
                "이방인의 사도 바울": "arch_paul"
            };
            return map[className] || className;
        }

        function readURL(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imageUpload').style.display = "none";
                    document.getElementById('upload-label-container').style.display = "none";
                    document.getElementById('image-preview-container').style.display = "block";
                    document.getElementById('imagePreview').setAttribute('src', e.target.result);
                    startAnalysis();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function startAnalysis() {
            document.getElementById("loading-area").style.display = "block";
            if (!model) {
                const success = await init();
                if (!success) {
                    document.getElementById("loading-area").style.display = "none";
                    return; 
                }
            }
            setTimeout(async () => {
                await predict();
            }, 1500);
        }

        // Re-predict if language changes and result area is visible
        window.addEventListener('languageChanged', () => {
            if (document.getElementById("result-area").style.display === "block") {
                predict();
            }
        });
    </script>
</body>
</html>